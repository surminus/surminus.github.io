<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/stylesheets/stylesheet.css">
  <link rel="canonical" href="/updating-this-blog-in-google-container-engine/">
  <link rel="alternate" type="application/rss+xml" title="surminus stuff" href="/feed.xml">
  <meta name="description" content="Boil the kettle and make a cup of tea">

   <title>Updating this blog in Google Container Engine</title>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-84007756-1', 'auto');
  ga('send', 'pageview');
  </script>


</head>


  <body>

    <header class="page-header">
     <h1 class="project-name"> <a class="header-link" href="/"> surminus stuff</a></h1>
     <!--<h3 style="font-weight: lighter;">a blog for <a class="header-link" href="http://canijustgo.com/" target="_blank">canijustgo.com</a></h3>-->
     <h3><a class="header-link" href="http://twitter.com/surminus" target="_blank">follow @surminus</a></h3>
</header>


    <section class="main-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="main-content" itemprop="articleBody">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Updating this blog in Google Container Engine</h1>
   <p class="post-meta"><time datetime="2016-09-11T00:00:00+01:00" itemprop="datePublished">Sep 11, 2016</time></p>
  </header>

    <h2 id="boil-the-kettle-and-make-a-cup-of-tea">Boil the kettle and make a cup of tea</h2>

<p>One thing that really fascinates me in new tech is <a href="http://kubernetes.io/">Kubernetes</a>.
Unfortunately it seems unlikely that we’ll be using in my current role anytime soon,
so I decided to simultaneously have a play and add some content at the same time; and
when I say have a play, I mean use <a href="https://cloud.google.com/container-engine/">Google Container Engine</a>.</p>

<p>My problem is I always try to do too much and get overwhelmed, but this time
I made myself keep it simple.</p>

<p>I really like the Google <code class="highlighter-rouge">gcloud</code> toolkit: it’s straight forward and documentation
is excellent. This site was originally running on a VM in <a href="https://cloud.google.com/compute/">Google Compute</a>,
and the experience for bringing up a basic VM was as it should be: quick auth, a couple of commands,
and an easy way to get data back for interaction. Super.</p>

<p>The first thing to do was create an image of the site using Docker. Since I’m
using <a href="https://jekyllrb.com/">Jekyll</a>, this was trivial. I <a href="https://github.com/surminus/blog/blob/master/Dockerfile">created a <code class="highlighter-rouge">Dockerfile</code></a>,
with <code class="highlighter-rouge">startup.sh</code> containing <a href="https://github.com/surminus/blog/blob/master/startup.sh">some binding info</a>.</p>

<p>I built the image with the tag <a href="https://cloud.google.com/container-registry/docs/pushing">documented by Google Container Registry</a>. For the purposes
here I’ll just refer to it as <code class="highlighter-rouge">$TAG</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker build -t <span class="nv">$TAG</span> .</code></pre></figure>

<p>Run it to make sure it’s OK…</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker run <span class="nv">$TAG</span></code></pre></figure>

<p>…and push it to the registry:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcloud docker push <span class="nv">$TAG</span></code></pre></figure>

<p>Next we need to make a cluster to run our <a href="http://kubernetes.io/docs/user-guide/pods/">“pods”</a>:
<a href="https://cloud.google.com/sdk/gcloud/reference/container/clusters/create"><code class="highlighter-rouge">gcloud container clusters create blog</code></a></p>

<p>This can take a little while, probably just enough time to drink the tea you made right at the beginning. When that’s done,
and you feel sufficiently warmed by the tea, it’s time to push our image into the cluster:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl run blog --image<span class="o">=</span><span class="nv">$TAG</span> --port<span class="o">=</span>4000</code></pre></figure>

<p>Before we get to see the service, we need to expose it a load balancer:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl expose deployment blog --port<span class="o">=</span>80 --target-port<span class="o">=</span>4000 --type<span class="o">=</span><span class="s2">"LoadBalancer"</span></code></pre></figure>

<p>Note the port forwarding; it’s running on tcp/4000 in the container, so we need to tell
the load balancer to forward traffic to it appropriately.</p>

<p>Grab the external IP of the deployment using:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  blog git:<span class="o">(</span>master<span class="o">)</span> ✗ kubectl get service blog
NAME      CLUSTER-IP     EXTERNAL-IP      PORT<span class="o">(</span>S<span class="o">)</span>   AGE
blog      10.3.252.135   23.251.133.125   80/TCP    1m</code></pre></figure>

<p>It’ll probably be in <code class="highlighter-rouge">&lt;pending&gt;</code> for perhaps a minute or two.</p>

<p>You can see some fuller information of this deployment:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  blog git:<span class="o">(</span>master<span class="o">)</span> ✗ kubectl describe service blog
Name:                   blog
Namespace:              default
Labels:                 <span class="nv">run</span><span class="o">=</span>blog
Selector:               <span class="nv">run</span><span class="o">=</span>blog
Type:                   LoadBalancer
IP:                     10.3.252.135
LoadBalancer Ingress:   23.251.133.125
Port:                   &lt;<span class="nb">unset</span>&gt; 80/TCP
NodePort:               &lt;<span class="nb">unset</span>&gt; 32368/TCP
Endpoints:              10.0.0.4:4000
Session Affinity:       None
Events:
  FirstSeen     LastSeen        Count   From                    SubobjectPath   Type            Reason                  Message
  ---------     --------        -----   ----                    -------------   --------        ------                  -------
  45m           45m             1       <span class="o">{</span>service-controller <span class="o">}</span>                   Normal          CreatingLoadBalancer    Creating load balancer
  44m           44m             1       <span class="o">{</span>service-controller <span class="o">}</span>                   Normal          CreatedLoadBalancer     Created load balancer</code></pre></figure>

<h2 id="updating-my-dns">Updating my DNS</h2>

<p>So now I have something running in Google Container Engine, and it was all pretty
straight forward. Unfortunately I still need to update the DNS, but fortunately
that’s also hosted at Google.</p>

<p>Let’s find out the current state:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcloud dns record-sets list -z <span class="nv">$ZONENAME</span></code></pre></figure>

<p>To add/edit/remove a record, you must start a transaction:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcloud dns record-sets transaction start -z <span class="nv">$ZONENAME</span></code></pre></figure>

<p>I already had a record set up for this, so I had to remove it, which is exactly the
same command as below, except replacing <code class="highlighter-rouge">remove</code> for <code class="highlighter-rouge">add</code>. The following adds my new
record;</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcloud dns record-sets transaction add 23.251.133.125 --name blog.surminus.co.uk. --ttl 300 --type A -z <span class="nv">$ZONENAME</span></code></pre></figure>

<p>Then execute the change, and view the changes:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcloud dns record-sets transaction execute -z <span class="nv">$ZONENAME</span>
gcloud dns record-sets list -z <span class="nv">$ZONENAME</span></code></pre></figure>

<p><em>I know setting the TTL makes me a rebel without a cause. Suck it up.</em></p>

<h2 id="thats-it">That’s it!</h2>

<p>That’s it!</p>

<p>If you’re reading this then it must have worked, and I actually have some content on my blog. Goodness.</p>

<h2 id="update">Update:</h2>

<p>Note that the guide above creates a default 3 node Kubernetes cluster in the Google Compute,
which costs a bit of money. I now actually host using Github pages. The LoadBalancing also costs,
and it’s probably more effective to just have an nginx instance running somewhere.</p>

  </div>

<a href=""><h3 style="text-align: center;">- to blog -</h3></a>

</article>

      </div>
    </div>

    <p style="font-size: 60%; text-align: right;">blog built using the <a href="https://github.com/jasonlong/cayman-theme">cayman-theme</a> by <a href="https://github.com/jasonlong">Jason Long</a>. <a href="http://creativecommons.org/licenses/by/4.0/">LICENSE</a></p>


  </body>

    


</html>
